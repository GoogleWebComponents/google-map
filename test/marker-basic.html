<!doctype html>
<!-- Copyright (c) 2014 Google Inc. All rights reserved. -->
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <script src="../../webcomponentsjs/webcomponents.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <link rel="import" href="../google-map.html">
  <link rel="import" href="marker-basic-elements.html">
</head>
<body>

  <google-map id="map1" latitude="37.77493" longitude="-122.41942">
    <google-map-marker latitude="37.779" longitude="-122.3892"></google-map-marker>
    <google-map-marker id="marker2" latitude="37.777" longitude="-122.38911" drag-events></google-map-marker>
  </google-map>

  <x-content stadiums='[{"title": "AT&T Park", "lat": 37.778611, "lng": -122.38916999999998}]'></x-content>

<script>
var map = document.querySelector('#map1');

suite('markers', function() {

  // TODO: add test for info window content, including empty & whitespace-only.
  test('infowindow', function() {
  });
  test.skip('infowindow');

  // TODO: test draggable, hidden, title properties.
  test('properties', function() {
  });
  test.skip('properties');

  // TODO: add test for drag and drop marker.
  test('dragdrop marker', function() {
  });
  test.skip('dragdrop marker');

  test('defaults', function() {
    var markerEl = Polymer.dom(map).querySelector('google-map-marker');
    assert.isUndefined(markerEl.marker);
    assert.isUndefined(markerEl.map);
    assert.isNull(markerEl.icon);
    assert.isNull(markerEl.info);
    assert.equal(markerEl.zIndex, 0);
    assert.equal(markerEl.latitude, 37.779);
    assert.equal(markerEl.longitude, -122.3892);
    assert.isFalse(markerEl.open);
    assert.isNull(markerEl.offsetParent,
                  'google-map-marker should be display: none');
  });

  test('update properties', function(done) {
    map.addEventListener('google-map-ready', function(e) {
      var markerEl = Polymer.dom(map).querySelector('google-map-marker');
      markerEl.latitude = 37.77493;
      markerEl.longitude = -122.41942;
      markerEl.zIndex = 1;
      assert.equal(
          markerEl.map, map.map, "marker's map is not the google-map's");

      flush(function() {
        assert.equal(markerEl.marker.getPosition().lat(), markerEl.latitude);
        assert.equal(markerEl.marker.getPosition().lng(), markerEl.longitude);
        assert.equal(markerEl.marker.getZIndex(), markerEl.zIndex);

        markerEl.icon = 'https://www.google.com/images/srpr/logo11w.png';
        flush(function() {
          assert.equal(markerEl.marker.getIcon(), markerEl.icon);

          done();
        });

      });

    });
  });

  test('update content', function(done) {
    var origLat = 37.778611,
        origLng = -122.38916999999998,
        origTitle = "AT&T Park";
    var contentEl = document.querySelector('x-content');
    var map2 = document.querySelector('x-content > google-map');
    var template = Polymer.dom(map2).querySelector('template');
    var markerEl = Polymer.dom(map2).querySelector('google-map-marker');
    assert.equal(markerEl.marker.getPosition().lat(), origLat);
    assert.equal(markerEl.marker.getPosition().lng(), origLng);
    assert.equal(markerEl.marker.title, origTitle);

    var newLat = 32.7073,
        newLng = -117.15660000000003,
        newTitle = "Petco Park";
    contentEl.setAttribute('stadiums','[{"title": "Petco Park", "lat": 32.7073, "lng": -117.1566}]');
    template.render();
    assert.equal(markerEl.marker.getPosition().lat(), newLat);
    assert.equal(markerEl.marker.getPosition().lng(), newLng);
    assert.equal(markerEl.marker.title, newTitle);
    done();
  });

  test('dragEvents', function() {

    var markerEl = Polymer.dom(map).querySelector('#marker2');

    assert.equal(markerEl.dragEvents, true);

    flush(function() {
      assert.instanceOf(markerEl._listeners.drag, google.maps.MapsEventListener);
      assert.instanceOf(markerEl._listeners.dragstart, google.maps.MapsEventListener);
      assert.instanceOf(markerEl._listeners.dragend, google.maps.MapsEventListener);
      done();
    });

  });

});

</script>
</body>
</html>
